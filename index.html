import React, { useState, useEffect, useRef } from 'react';
import { Send, Search, Settings, Smile, MoreVertical, Zap, LogOut } from 'lucide-react';

const MASCOT_URL = "https://i.ibb.co/XfXkY8S/Gemini-Generated-Image-nnd32mnnd32mnnd3.jpg";

export default function App() {
    const [isLoading, setIsLoading] = useState(true);
    const [isLoggedIn, setIsLoggedIn] = useState(false);
    const [user, setUser] = useState(null);
    const [activeChat, setActiveChat] = useState(null);
    const [message, setMessage] = useState("");
    const [searchQuery, setSearchQuery] = useState("");
    const [showProfile, setShowProfile] = useState(false);
    
    const [authForm, setAuthForm] = useState({ username: '' });
    
    // –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ localStorage –≤ iframe
    const [chats] = useState([
        { id: 1, name: '–ü–∞–≤–µ–ª –î—É—Ä–æ–≤', avatar: 'P', color: '#0088cc', lastMsg: 'SmeshGram ‚Äî —ç—Ç–æ –±—É–¥—É—â–µ–µ.', time: '12:44', isOnline: true },
        { id: 2, name: 'Smesh AI', avatar: 'ü§ñ', color: '#3b82f6', lastMsg: '–Ø –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å.', time: '10:00', isOnline: true },
        { id: 3, name: '–ö—Ä–∏–ø—Ç–æ –ò–Ω–≤–µ—Å—Ç–æ—Ä', avatar: 'C', color: '#f59e0b', lastMsg: '–ñ–¥—É —Å–∏–≥–Ω–∞–ª—ã!', time: '–í—á–µ—Ä–∞', isOnline: false }
    ]);

    const [messages, setMessages] = useState({
        1: [{ id: 1, text: '–ü—Ä–∏–≤–µ—Ç! SmeshGram ‚Äî —ç—Ç–æ –±—É–¥—É—â–µ–µ.', sender: 'them', time: '12:44' }],
        2: [{ id: 1, text: '–ü—Ä–∏–≤–µ—Ç, –°–º–µ—à! –Ø —Ç–≤–æ–π –ª–∏—á–Ω—ã–π –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç.', sender: 'them', time: '10:00' }]
    });

    const scrollRef = useRef(null);

    // –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
    useEffect(() => {
        const timer = setTimeout(() => setIsLoading(false), 1500);
        return () => clearTimeout(timer);
    }, []);

    // –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –≤–Ω–∏–∑ –ø—Ä–∏ –Ω–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
    useEffect(() => {
        if (scrollRef.current) {
            scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
        }
    }, [messages, activeChat]);

    const handleLogin = (e) => {
        e.preventDefault();
        if (!authForm.username.trim()) return;
        setUser({ username: authForm.username });
        setIsLoggedIn(true);
    };

    const handleLogout = () => {
        setIsLoggedIn(false);
        setUser(null);
        setShowProfile(false);
        setActiveChat(null);
    };

    const sendMessage = () => {
        if (!activeChat || !message.trim()) return;
        
        const newMsg = {
            id: Date.now(),
            text: message,
            sender: 'me',
            time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
        };
        
        setMessages(prev => ({
            ...prev,
            [activeChat]: [...(prev[activeChat] || []), newMsg]
        }));
        
        setMessage("");

        // –û—Ç–≤–µ—Ç –æ—Ç –ò–ò, –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–µ–Ω —á–∞—Ç ‚Ññ2
        if (activeChat === 2) {
            setTimeout(() => {
                const aiReply = {
                    id: Date.now() + 1,
                    text: "–ü—Ä–∏–Ω—è–ª! –í—ã–ø–æ–ª–Ω—è—é –Ω–µ–π—Ä–æ-–æ–±—Ä–∞–±–æ—Ç–∫—É —Ç–≤–æ–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞...",
                    sender: 'them',
                    time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                };
                setMessages(prev => ({
                    ...prev,
                    2: [...(prev[2] || []), aiReply]
                }));
            }, 1000);
        }
    };

    // –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏
    if (isLoading) {
        return (
            <div className="fixed inset-0 bg-[#020617] flex flex-col items-center justify-center z-[100]">
                <div className="w-24 h-24 border-4 border-blue-500/20 border-t-blue-500 rounded-[2rem] animate-spin flex items-center justify-center relative shadow-[0_0_50px_rgba(59,130,246,0.3)]">
                    <div className="absolute inset-0 flex items-center justify-center animate-pulse rotate-[-100deg]">
                        <Zap className="text-blue-500 fill-blue-500" size={32} />
                    </div>
                </div>
                <h1 className="mt-8 text-2xl font-black italic text-white tracking-[0.3em] uppercase drop-shadow-[0_0_10px_rgba(59,130,246,0.5)]">
                    Smesh<span className="text-blue-500">Gram</span>
                </h1>
                <p className="text-blue-500/50 mt-4 text-xs tracking-widest uppercase animate-pulse">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</p>
            </div>
        );
    }

    // –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞
    if (!isLoggedIn) {
        return (
            <div className="min-h-screen bg-[#020617] flex items-center justify-center p-6 relative overflow-hidden font-sans">
                {/* –≠—Ñ—Ñ–µ–∫—Ç—ã —Å–≤–µ—á–µ–Ω–∏—è –Ω–∞ —Ñ–æ–Ω–µ */}
                <div className="absolute top-[-10%] left-[-10%] w-[500px] h-[500px] bg-blue-600/20 rounded-full blur-[120px]"></div>
                <div className="absolute bottom-[-10%] right-[-10%] w-[500px] h-[500px] bg-indigo-600/20 rounded-full blur-[120px]"></div>
                
                <div className="max-w-md w-full bg-[#0f172a]/80 backdrop-blur-xl border border-white/10 rounded-[2.5rem] p-10 relative z-10 shadow-2xl text-center">
                    <div className="relative inline-block mb-6">
                        <div className="absolute inset-0 bg-blue-500 rounded-full blur-xl opacity-50 animate-pulse"></div>
                        <img 
                            src={MASCOT_URL} 
                            alt="Smesh Mascot" 
                            className="w-32 h-32 mx-auto rounded-full border-4 border-[#020617] relative z-10 object-cover"
                        />
                    </div>
                    
                    <h2 className="text-4xl font-black italic text-white uppercase tracking-tighter mb-2">
                        Smesh<span className="text-blue-500">Gram</span>
                    </h2>
                    <p className="text-slate-400 text-sm mb-8">–ó–∞—â–∏—â–µ–Ω–Ω–∞—è –Ω–µ–π—Ä–æ–Ω–Ω–∞—è —Å–µ—Ç—å</p>
                    
                    <form onSubmit={handleLogin} className="space-y-4">
                        <input 
                            type="text" 
                            placeholder="–í–≤–µ–¥–∏ –Ω–∏–∫–Ω–µ–π–º"
                            required
                            className="w-full bg-slate-800/50 border border-white/5 rounded-2xl py-4 px-6 text-white placeholder-slate-500 focus:outline-none focus:border-blue-500/50 transition-colors"
                            value={authForm.username}
                            onChange={e => setAuthForm({ username: e.target.value })}
                        />
                        <button 
                            type="submit"
                            className="w-full bg-blue-600 hover:bg-blue-500 text-white font-black uppercase tracking-widest py-4 rounded-2xl transition-all shadow-lg shadow-blue-600/20 active:scale-95"
                        >
                            –í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É
                        </button>
                    </form>
                </div>
            </div>
        );
    }

    const filteredChats = chats.filter(c => c.name.toLowerCase().includes(searchQuery.toLowerCase()));

    // –ì–ª–∞–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    return (
        <div className="h-screen flex bg-[#020617] text-slate-200 overflow-hidden font-sans">
            {/* –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ */}
            <style>{`
                ::-webkit-scrollbar { width: 6px; }
                ::-webkit-scrollbar-track { background: transparent; }
                ::-webkit-scrollbar-thumb { background: rgba(59, 130, 246, 0.2); border-radius: 10px; }
                ::-webkit-scrollbar-thumb:hover { background: rgba(59, 130, 246, 0.5); }
            `}</style>

            {/* –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å (—Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤) */}
            <div className={`w-full md:w-[380px] border-r border-white/5 flex flex-col bg-[#0f172a]/50 backdrop-blur-md ${activeChat ? 'hidden md:flex' : 'flex'}`}>
                {/* –®–∞–ø–∫–∞ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ */}
                <div className="p-6">
                    <div className="flex items-center justify-between mb-6">
                        <button 
                            onClick={() => setShowProfile(true)}
                            className="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center font-black text-white shadow-lg hover:scale-105 transition-transform"
                        >
                            {user.username[0].toUpperCase()}
                        </button>
                        <h1 className="text-xl font-black italic uppercase tracking-tighter">
                            Smesh<span className="text-blue-500">Gram</span>
                        </h1>
                        <button className="text-slate-500 hover:text-white transition-colors">
                            <Settings size={22} />
                        </button>
                    </div>
                    <div className="relative">
                        <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500" size={18} />
                        <input 
                            placeholder="–ü–æ–∏—Å–∫..." 
                            className="w-full bg-[#020617]/50 border border-white/10 rounded-2xl py-3 pl-12 pr-4 text-sm text-white focus:outline-none focus:border-blue-500/50 transition-colors"
                            value={searchQuery}
                            onChange={e => setSearchQuery(e.target.value)}
                        />
                    </div>
                </div>
                
                {/* –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ */}
                <div className="flex-1 overflow-y-auto px-3 pb-4">
                    {filteredChats.map(chat => (
                        <div 
                            key={chat.id} 
                            onClick={() => setActiveChat(chat.id)}
                            className={`flex items-center gap-4 p-4 rounded-3xl cursor-pointer mb-2 transition-all ${
                                activeChat === chat.id 
                                ? 'bg-blue-600 shadow-lg shadow-blue-600/20' 
                                : 'hover:bg-white/5'
                            }`}
                        >
                            <div 
                                className="w-14 h-14 rounded-[1.2rem] flex items-center justify-center font-bold text-xl relative shadow-inner" 
                                style={{backgroundColor: chat.color}}
                            >
                                {chat.avatar}
                                {chat.isOnline && (
                                    <div className="absolute -bottom-1 -right-1 w-4 h-4 bg-green-500 border-4 border-[#0f172a] rounded-full"></div>
                                )}
                            </div>
                            <div className="flex-1 min-w-0">
                                <div className="flex justify-between items-center mb-1">
                                    <span className="font-bold text-[15px] truncate text-white">{chat.name}</span>
                                    <span className="text-[11px] text-slate-400 font-medium">{chat.time}</span>
                                </div>
                                <p className={`text-sm truncate ${activeChat === chat.id ? 'text-blue-100' : 'text-slate-400'}`}>
                                    {chat.lastMsg}
                                </p>
                            </div>
                        </div>
                    ))}
                </div>
            </div>

            {/* –û–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ */}
            <div className={`flex-1 flex flex-col relative ${!activeChat ? 'hidden md:flex' : 'flex'}`}>
                {activeChat ? (
                    <>
                        {/* –®–∞–ø–∫–∞ —á–∞—Ç–∞ */}
                        <div className="p-4 border-b border-white/5 flex items-center justify-between bg-[#0f172a]/80 backdrop-blur-md z-10">
                            <div className="flex items-center gap-4">
                                <button 
                                    className="md:hidden text-slate-400 hover:text-white"
                                    onClick={() => setActiveChat(null)}
                                >
                                    ‚Üê –ù–∞–∑–∞–¥
                                </button>
                                <div 
                                    className="w-12 h-12 rounded-2xl flex items-center justify-center font-bold text-lg" 
                                    style={{backgroundColor: chats.find(c => c.id === activeChat).color}}
                                >
                                    {chats.find(c => c.id === activeChat).avatar}
                                </div>
                                <div>
                                    <h2 className="font-bold text-white text-[16px]">
                                        {chats.find(c => c.id === activeChat).name}
                                    </h2>
                                    <span className="text-[11px] text-green-400 font-medium tracking-wide">
                                        –í —Å–µ—Ç–∏
                                    </span>
                                </div>
                            </div>
                            <button className="p-2 text-slate-400 hover:text-white rounded-full hover:bg-white/5 transition-colors">
                                <MoreVertical size={20} />
                            </button>
                        </div>

                        {/* –°–æ–æ–±—â–µ–Ω–∏—è */}
                        <div ref={scrollRef} className="flex-1 overflow-y-auto p-6 space-y-6">
                            {(messages[activeChat] || []).map(msg => (
                                <div key={msg.id} className={`flex ${msg.sender === 'me' ? 'justify-end' : 'justify-start'}`}>
                                    <div className={`max-w-[85%] md:max-w-[70%] p-4 text-[15px] shadow-xl ${
                                        msg.sender === 'me' 
                                        ? 'bg-blue-600 text-white rounded-[2rem] rounded-tr-sm' 
                                        : 'bg-[#1e293b] text-slate-100 rounded-[2rem] rounded-tl-sm border border-white/5'
                                    }`}>
                                        <p className="leading-relaxed">{msg.text}</p>
                                        <div className={`text-[10px] mt-2 font-medium ${
                                            msg.sender === 'me' ? 'text-blue-200 text-right' : 'text-slate-400 text-right'
                                        }`}>
                                            {msg.time}
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>

                        {/* –ü–æ–ª–µ –≤–≤–æ–¥–∞ */}
                        <div className="p-4 bg-[#0f172a]/80 backdrop-blur-md border-t border-white/5">
                            <div className="max-w-4xl mx-auto flex items-center gap-2 bg-[#020617] p-2 rounded-full border border-white/10">
                                <button className="p-3 text-slate-400 hover:text-white transition-colors rounded-full hover:bg-white/5">
                                    <Smile size={22} />
                                </button>
                                <input 
                                    placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                                    className="flex-1 bg-transparent border-none py-3 px-2 text-[15px] text-white focus:outline-none"
                                    value={message}
                                    onChange={e => setMessage(e.target.value)}
                                    onKeyPress={e => e.key === 'Enter' && sendMessage()}
                                />
                                <button 
                                    onClick={sendMessage} 
                                    disabled={!message.trim()}
                                    className="bg-blue-600 p-3 rounded-full text-white hover:bg-blue-500 transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg"
                                >
                                    <Send size={20} className="ml-1" />
                                </button>
                            </div>
                        </div>
                    </>
                ) : (
                    /* –ó–∞–≥–ª—É—à–∫–∞, –∫–æ–≥–¥–∞ —á–∞—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω */
                    <div className="flex-1 flex flex-col items-center justify-center bg-[#020617]">
                        <div className="relative mb-6">
                            <div className="absolute inset-0 bg-blue-500 rounded-full blur-3xl opacity-20"></div>
                            <img src={MASCOT_URL} className="w-48 h-48 rounded-full border-4 border-white/5 relative z-10 grayscale opacity-50" />
                        </div>
                        <p className="text-slate-500 font-medium text-sm bg-[#0f172a] px-6 py-3 rounded-full border border-white/5">
                            –í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –Ω–∞—á–∞–ª–∞ –æ–±—â–µ–Ω–∏—è
                        </p>
                    </div>
                )}
            </div>

            {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è */}
            {showProfile && (
                <div 
                    className="fixed inset-0 bg-[#020617]/80 backdrop-blur-sm z-[100] flex items-center justify-center p-6 animate-in fade-in duration-200" 
                    onClick={() => setShowProfile(false)}
                >
                    <div 
                        className="max-w-sm w-full bg-[#0f172a] border border-white/10 p-8 rounded-[2.5rem] text-center shadow-2xl relative" 
                        onClick={e => e.stopPropagation()}
                    >
                        <button 
                            className="absolute top-6 right-6 text-slate-500 hover:text-white"
                            onClick={() => setShowProfile(false)}
                        >
                            <Zap size={20} />
                        </button>
                        
                        <div className="w-28 h-28 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-[2rem] mx-auto mb-6 flex items-center justify-center text-4xl font-black text-white shadow-lg">
                            {user.username[0].toUpperCase()}
                        </div>
                        
                        <h2 className="text-2xl font-bold text-white mb-1">{user.username}</h2>
                        <p className="text-sm text-blue-400 font-bold tracking-widest uppercase mb-8">Smesh Member</p>
                        
                        <div className="space-y-3">
                            <div className="bg-[#020617] p-4 rounded-2xl border border-white/5 flex items-center justify-between text-sm">
                                <span className="text-slate-400">–°—Ç–∞—Ç—É—Å —Å–µ—Ç–∏</span>
                                <span className="text-green-400 font-medium">–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ</span>
                            </div>
                            <button 
                                className="w-full py-4 rounded-2xl bg-red-500/10 text-red-500 hover:bg-red-500/20 font-bold transition-colors flex items-center justify-center gap-2" 
                                onClick={handleLogout}
                            >
                                <LogOut size={18} />
                                –í–´–ô–¢–ò –ò–ó –°–ò–°–¢–ï–ú–´
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}
