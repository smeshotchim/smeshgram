<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmeshGram Ultimate ‚Äî Hyper Drive</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        :root {
            --primary: #3b82f6;
            --bg-dark: #020617;
            --glass: rgba(15, 23, 42, 0.85);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: var(--bg-dark);
            color: #f8fafc;
            margin: 0;
            overflow: hidden;
            height: 100vh;
        }

        .glass {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* –¢–≤–æ—è –∞–≤–∞—Ç–∞—Ä–∫–∞ */
        .smesh-avatar {
            background-image: url('https://r.jina.ai/i/9e67c858be8540c1a9657c91795796f6');
            background-size: cover;
            background-position: center;
        }

        /* –ö–∞—Å—Ç–æ–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª */
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(59, 130, 246, 0.3); border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: rgba(59, 130, 246, 0.5); }

        @keyframes pulse-blue {
            0%, 100% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.2); }
            50% { box-shadow: 0 0 40px rgba(59, 130, 246, 0.4); }
        }
        .prime-glow { animation: pulse-blue 3s infinite; }

        .message-appear {
            animation: slideUp 0.3s ease-out forwards;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="antialiased">

    <!-- –ó–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —ç–∫—Ä–∞–Ω -->
    <div id="boot-screen" class="fixed inset-0 z-[1000] bg-[#020617] flex flex-col items-center justify-center transition-opacity duration-700">
        <div class="w-28 h-28 smesh-avatar rounded-[2rem] border-4 border-blue-600 shadow-[0_0_50px_rgba(59,130,246,0.3)] animate-bounce"></div>
        <h2 class="mt-8 text-4xl font-black italic uppercase tracking-tighter">Smesh<span class="text-blue-500">Gram</span></h2>
        <div class="mt-6 w-48 h-1 bg-slate-900 rounded-full overflow-hidden">
            <div id="boot-progress" class="h-full bg-blue-500 w-0 transition-all duration-300"></div>
        </div>
        <p class="mt-4 text-slate-500 font-mono text-[10px] uppercase tracking-[0.2em]" id="boot-status">Initializing Neural Link...</p>
    </div>

    <!-- –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (–õ–µ–Ω–¥–∏–Ω–≥) -->
    <div id="landing-page" class="hidden h-screen overflow-y-auto custom-scroll bg-[radial-gradient(circle_at_top_right,_var(--tw-gradient-stops))] from-blue-900/20 via-slate-950 to-slate-950">
        <nav class="fixed top-0 w-full z-50 p-6">
            <div class="max-w-5xl mx-auto glass rounded-3xl p-4 flex justify-between items-center px-8">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 smesh-avatar rounded-xl border border-blue-500/30"></div>
                    <span class="font-black text-xl italic uppercase tracking-tighter">SmeshGram</span>
                </div>
                <button onclick="router.navigate('auth')" class="bg-blue-600 hover:bg-blue-500 px-8 py-2.5 rounded-xl font-bold transition-all transform active:scale-95 shadow-lg shadow-blue-900/20">
                    –í–æ–π—Ç–∏
                </button>
            </div>
        </nav>

        <section class="pt-40 pb-20 px-6 text-center max-w-5xl mx-auto">
            <span class="inline-block py-1 px-4 rounded-full bg-blue-500/10 border border-blue-500/20 text-blue-400 text-[10px] font-black uppercase tracking-widest mb-6">Ultra Production Ready</span>
            <h1 class="text-6xl md:text-8xl font-black mb-8 leading-[0.9] tracking-tighter uppercase italic">–ë—É–¥—É—â–µ–µ <br><span class="text-blue-500">–û–±—â–µ–Ω–∏—è</span></h1>
            <p class="text-slate-400 text-lg md:text-xl max-w-2xl mx-auto mb-12 font-medium">–ö—Ä—É—Ç–æ–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä –¥–ª—è —Ç–µ—Ö, –∫—Ç–æ —Ü–µ–Ω–∏—Ç —Å—Ç–∏–ª—å, –º–æ—â—å –∏ –ø–æ–ª–Ω—É—é –∞–Ω–æ–Ω–∏–º–Ω–æ—Å—Ç—å. –°–æ–∑–¥–∞–Ω —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è –°–º–µ—à–∞.</p>
            
            <div class="flex flex-col sm:row justify-center gap-4 mb-20">
                <button onclick="router.navigate('auth')" class="bg-white text-slate-950 px-10 py-5 rounded-2xl font-black text-lg hover:bg-blue-50 transition-all">–ó–ê–ù–Ø–¢–¨ –ù–ò–ö–ù–ï–ô–ú</button>
                <div class="glass px-10 py-5 rounded-2xl font-bold flex items-center justify-center gap-3">
                    <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                    Servers: ONLINE
                </div>
            </div>

            <div class="grid md:grid-cols-3 gap-6">
                <div class="glass p-8 rounded-[2.5rem] text-left">
                    <div class="w-12 h-12 bg-blue-600/20 rounded-2xl flex items-center justify-center text-blue-500 mb-6"><i data-lucide="zap"></i></div>
                    <h3 class="font-black text-xl mb-2 italic">–ú–û–õ–ù–ò–ï–ù–û–°–ù–û</h3>
                    <p class="text-slate-500 text-sm">–¢–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–æ—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –±—ã—Å—Ç—Ä–µ–µ, —á–µ–º —Ç—ã —É—Å–ø–µ–≤–∞–µ—à—å –º–æ—Ä–≥–Ω—É—Ç—å.</p>
                </div>
                <div class="glass p-8 rounded-[2.5rem] text-left">
                    <div class="w-12 h-12 bg-emerald-600/20 rounded-2xl flex items-center justify-center text-emerald-500 mb-6"><i data-lucide="shield-check"></i></div>
                    <h3 class="font-black text-xl mb-2 italic">–ê–ù–û–ù–ò–ú–ù–û</h3>
                    <p class="text-slate-500 text-sm">–ù–∏–∫–∞–∫–∏—Ö –Ω–æ–º–µ—Ä–æ–≤ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤. –¢–≤–æ–π –Ω–∏–∫ ‚Äî —Ç–≤–æ–∏ –ø—Ä–∞–≤–∏–ª–∞.</p>
                </div>
                <div class="glass p-8 rounded-[2.5rem] text-left border-blue-500/30">
                    <div class="w-12 h-12 bg-amber-600/20 rounded-2xl flex items-center justify-center text-amber-500 mb-6"><i data-lucide="crown"></i></div>
                    <h3 class="font-black text-xl mb-2 italic text-amber-500 font-bold uppercase">PRIME –°–¢–ê–¢–£–°</h3>
                    <p class="text-slate-500 text-sm">–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å—Ç–∏–∫–µ—Ä—ã –∏ –∫–æ—Ä–æ–Ω–∞ –≤–æ–∑–ª–µ –Ω–∏–∫–∞ –¥–ª—è –Ω–∞—Å—Ç–æ—è—â–∏—Ö –∫–æ—Ä–æ–ª–µ–π.</p>
                </div>
            </div>
        </section>
    </div>

    <!-- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
    <div id="auth-page" class="hidden min-h-screen items-center justify-center p-6 bg-slate-950">
        <div class="glass w-full max-w-md p-10 rounded-[3rem] text-center shadow-2xl relative overflow-hidden">
            <div class="absolute -top-20 -left-20 w-40 h-40 bg-blue-600/20 blur-[80px]"></div>
            <div class="w-24 h-24 smesh-avatar rounded-3xl mx-auto mb-8 border-2 border-blue-600 shadow-2xl shadow-blue-900/20"></div>
            <h2 class="text-3xl font-black mb-2 italic uppercase">SmeshGram</h2>
            <p class="text-slate-500 text-sm mb-10">–ü—Ä–æ—Å—Ç–æ –≤–≤–µ–¥–∏ —Å–≤–æ–π –Ω–∏–∫, —á—Ç–æ–±—ã –≤–æ–π—Ç–∏.</p>
            
            <input id="auth-username" type="text" placeholder="–¢–≤–æ–π –∫—Ä—É—Ç–æ–π –Ω–∏–∫" 
                class="w-full bg-slate-900/50 border border-slate-800 rounded-2xl py-4 px-6 mb-4 outline-none focus:border-blue-500 text-white font-bold transition-all text-center">
            
            <button id="auth-btn" class="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-2xl font-black text-lg transition-all transform active:scale-95 shadow-xl shadow-blue-900/40">
                –í–û–ô–¢–ò –í –°–ò–°–¢–ï–ú–£
            </button>
            <p class="mt-6 text-[10px] text-slate-600 uppercase tracking-widest">End-to-End Encryption Enabled</p>
        </div>
    </div>

    <!-- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–ß–∞—Ç) -->
    <div id="app-page" class="hidden h-screen flex flex-col bg-[#020617]">
        <!-- –®–∞–ø–∫–∞ -->
        <header class="h-20 glass border-b border-slate-900 flex items-center justify-between px-6 shrink-0 z-50">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 smesh-avatar rounded-2xl border-2 border-blue-500 prime-glow"></div>
                <div>
                    <h2 class="font-black italic text-lg tracking-tighter uppercase leading-none">SmeshGram</h2>
                    <span id="user-display-name" class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">User</span>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="ui.toggleModal('settings-modal', true)" class="p-3 hover:bg-slate-800 rounded-2xl transition-all text-slate-400 hover:text-white"><i data-lucide="settings" class="w-5 h-5"></i></button>
                <button onclick="appManager.logout()" class="p-3 hover:bg-red-500/10 text-red-500 rounded-2xl transition-all"><i data-lucide="log-out" class="w-5 h-5"></i></button>
            </div>
        </header>

        <div class="flex-1 flex overflow-hidden">
            <!-- –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ (–ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å) -->
            <aside class="w-80 border-r border-slate-900 flex flex-col bg-slate-950/20 shrink-0 hidden lg:flex">
                <div class="p-4">
                    <div class="relative">
                        <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-600"></i>
                        <input type="text" placeholder="–ü–æ–∏—Å–∫..." class="w-full bg-slate-900 border border-slate-800 rounded-xl py-2.5 pl-12 pr-4 text-sm outline-none focus:border-blue-500/50">
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto custom-scroll px-2 space-y-1">
                    <div class="p-4 flex items-center gap-3 bg-blue-600/10 rounded-2xl border border-blue-500/20 cursor-pointer">
                        <div class="w-12 h-12 rounded-2xl smesh-avatar border border-blue-500 flex items-center justify-center font-bold"></div>
                        <div class="flex-1 overflow-hidden">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-sm italic">Global Smesh</span>
                                <span class="text-[9px] text-slate-500 font-bold uppercase">Online</span>
                            </div>
                            <p class="text-xs text-slate-400 truncate mt-0.5">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è –∫ –æ–±—â–µ–Ω–∏—é!</p>
                        </div>
                    </div>
                    <!-- –ó–∞–≥–ª—É—à–∫–∏ -->
                    <div class="p-4 flex items-center gap-3 opacity-30 cursor-not-allowed grayscale">
                        <div class="w-12 h-12 rounded-2xl bg-slate-800 flex items-center justify-center font-bold text-slate-500">D</div>
                        <div class="flex-1">
                            <span class="font-bold text-sm">Pavel Durov</span>
                            <p class="text-xs">Offline</p>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- –û–∫–Ω–æ —á–∞—Ç–∞ -->
            <main class="flex-1 flex flex-col relative bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] bg-fixed">
                <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
                <div id="messages-container" class="flex-1 overflow-y-auto p-6 space-y-6 custom-scroll">
                    <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç —Å–æ–æ–±—â–µ–Ω–∏—è -->
                </div>

                <!-- –ü–∞–Ω–µ–ª—å —Å—Ç–∏–∫–µ—Ä–æ–≤ -->
                <div id="sticker-picker" class="hidden absolute bottom-28 left-6 glass p-6 rounded-[2.5rem] w-80 shadow-2xl z-50 border-blue-500/20">
                    <div class="flex justify-between items-center mb-4 px-1">
                        <p class="text-[10px] font-black uppercase text-slate-500 tracking-widest">Smesh Premium Stickers</p>
                        <i data-lucide="sparkles" class="w-3 h-3 text-amber-500"></i>
                    </div>
                    <div class="grid grid-cols-4 gap-4">
                        <button onclick="appManager.sendSticker('üóø')" class="text-3xl hover:scale-125 transition-all active:scale-90">üóø</button>
                        <button onclick="appManager.sendSticker('ü¶æ')" class="text-3xl hover:scale-125 transition-all active:scale-90">ü¶æ</button>
                        <button onclick="appManager.sendSticker('üî•')" class="text-3xl hover:scale-125 transition-all active:scale-90">üî•</button>
                        <button onclick="appManager.sendSticker('üëë')" class="text-3xl hover:scale-125 transition-all active:scale-90">üëë</button>
                        <button onclick="appManager.sendSticker('üòé')" class="text-3xl hover:scale-125 transition-all active:scale-90">üòé</button>
                        <button onclick="appManager.sendSticker('üöÄ')" class="text-3xl hover:scale-125 transition-all active:scale-90">üöÄ</button>
                        <button onclick="appManager.sendSticker('‚ö°')" class="text-3xl hover:scale-125 transition-all active:scale-90">‚ö°</button>
                        <button onclick="appManager.sendSticker('üíé')" class="text-3xl hover:scale-125 transition-all active:scale-90">üíé</button>
                    </div>
                </div>

                <!-- –í–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è -->
                <div class="p-6 bg-slate-950/80 border-t border-slate-900 backdrop-blur-md">
                    <div class="max-w-4xl mx-auto flex items-center gap-3 relative">
                        <button onclick="ui.toggleStickers()" class="p-4 bg-slate-900 border border-slate-800 rounded-2xl text-slate-500 hover:text-blue-400 hover:border-blue-500/50 transition-all transform active:scale-95">
                            <i data-lucide="smile"></i>
                        </button>
                        <input id="message-input" type="text" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å –≤ SmeshGram..." 
                            class="flex-1 bg-slate-900 border border-slate-800 rounded-2xl py-4 px-6 outline-none focus:border-blue-500 text-white transition-all shadow-inner">
                        <button id="send-btn" class="w-14 h-14 bg-blue-600 hover:bg-blue-500 text-white rounded-2xl flex items-center justify-center shadow-lg shadow-blue-900/40 transition-all transform active:scale-95">
                            <i data-lucide="send" class="w-6 h-6"></i>
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
    <div id="settings-modal" class="hidden fixed inset-0 z-[2000] bg-black/90 backdrop-blur-sm flex items-center justify-center p-6">
        <div class="glass w-full max-w-sm p-10 rounded-[3rem] relative animate-in zoom-in duration-200">
            <button onclick="ui.toggleModal('settings-modal', false)" class="absolute top-8 right-8 text-slate-600 hover:text-white transition-all"><i data-lucide="x"></i></button>
            <h3 class="text-2xl font-black mb-8 italic uppercase tracking-tighter">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
            
            <div class="space-y-4">
                <div class="flex items-center justify-between p-5 bg-slate-900/50 rounded-3xl border border-slate-800 transition-all hover:border-blue-500/30">
                    <div>
                        <p class="font-black text-sm uppercase italic">Prime Status</p>
                        <p class="text-[10px] text-slate-500 uppercase tracking-widest mt-0.5">Visual Badge & Exclusive Stickers</p>
                    </div>
                    <button id="prime-toggle" onclick="appManager.togglePrime()" class="w-12 h-6 bg-slate-800 rounded-full relative transition-all duration-300">
                        <div class="w-4 h-4 bg-white rounded-full absolute top-1 left-1 transition-all duration-300"></div>
                    </button>
                </div>
                
                <div class="pt-6">
                    <button onclick="appManager.clearAllData()" class="w-full py-4 text-red-500 text-[10px] font-black uppercase tracking-[0.3em] hover:bg-red-500/5 rounded-2xl transition-all">
                        Delete Local Cache
                    </button>
                </div>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, doc, setDoc, collection, query, onSnapshot, 
        addDoc, serverTimestamp, deleteDoc 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (Empty key because execution env provides it)
    const firebaseConfig = JSON.parse(__firebase_config);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'smesh-gram-ultimate-3';

    const state = {
        app: initializeApp(firebaseConfig),
        auth: null,
        db: null,
        user: null,
        profile: {
            name: localStorage.getItem('sm_name') || '',
            isPrime: localStorage.getItem('sm_prime') === 'true'
        }
    };

    state.auth = getAuth(state.app);
    state.db = getFirestore(state.app);

    const ui = {
        screens: {
            landing: document.getElementById('landing-page'),
            auth: document.getElementById('auth-page'),
            app: document.getElementById('app-page')
        },
        navigate(id) {
            Object.values(this.screens).forEach(s => s.classList.add('hidden'));
            Object.values(this.screens).forEach(s => s.classList.remove('flex'));
            
            if(id === 'auth' || id === 'app') {
                this.screens[id].classList.remove('hidden');
                this.screens[id].classList.add('flex');
            } else {
                this.screens[id].classList.remove('hidden');
            }
            if (window.lucide) lucide.createIcons();
        },
        toggleModal(id, show) {
            const m = document.getElementById(id);
            m.classList.toggle('hidden', !show);
            if (show && window.lucide) lucide.createIcons();
        },
        toggleStickers() {
            document.getElementById('sticker-picker').classList.toggle('hidden');
        },
        renderMessage(msg) {
            const container = document.getElementById('messages-container');
            const isMe = msg.uid === state.user?.uid;
            const isSticker = msg.type === 'sticker';
            
            const div = document.createElement('div');
            div.className = `flex flex-col ${isMe ? 'items-end' : 'items-start'} message-appear`;
            
            div.innerHTML = `
                <div class="flex items-center gap-1.5 mb-1.5 px-2">
                    ${msg.isPrime ? '<span class="text-amber-500 text-[10px]">üëë</span>' : ''}
                    <span class="text-[9px] font-black uppercase text-slate-500 tracking-wider">${msg.sender}</span>
                </div>
                <div class="${isSticker ? 'text-6xl p-2 select-none' : 'max-w-[85%] px-5 py-3.5 rounded-3xl text-sm font-medium ' + (isMe ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-slate-900 text-slate-200 border border-slate-800 rounded-tl-none')} shadow-2xl">
                    ${msg.text}
                </div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }
    };

    const appManager = {
        async init() {
            const progress = document.getElementById('boot-progress');
            const status = document.getElementById('boot-status');
            
            try {
                progress.style.width = '40%';
                status.innerText = "Syncing with Smesh-Net...";

                onAuthStateChanged(state.auth, async (user) => {
                    state.user = user;
                    progress.style.width = '100%';
                    setTimeout(() => this.handleSession(), 600);
                });

                this.setupListeners();
                this.updateUIState();

            } catch (err) {
                status.innerText = "Error: " + err.message;
                status.classList.add('text-red-500');
            }
        },

        handleSession() {
            if (state.user && state.profile.name) {
                document.getElementById('user-display-name').innerText = state.profile.name;
                ui.navigate('app');
                this.startListening();
            } else {
                ui.navigate('landing');
            }
            document.getElementById('boot-screen').style.opacity = '0';
            setTimeout(() => document.getElementById('boot-screen').classList.add('hidden'), 700);
        },

        setupListeners() {
            document.getElementById('auth-btn').onclick = async () => {
                const nameInput = document.getElementById('auth-username');
                const name = nameInput.value.trim();
                if (name.length < 2) return;
                
                state.profile.name = name;
                localStorage.setItem('sm_name', name);
                
                await signInAnonymously(state.auth);
            };

            document.getElementById('send-btn').onclick = () => this.sendMessage();
            document.getElementById('message-input').onkeypress = (e) => e.key === 'Enter' && this.sendMessage();
        },

        async sendMessage() {
            const input = document.getElementById('message-input');
            const val = input.value.trim();
            if (!val || !state.user) return;
            input.value = '';
            await this.pushMsg(val, 'text');
        },

        async sendSticker(emoji) {
            ui.toggleStickers();
            await this.pushMsg(emoji, 'sticker');
        },

        async pushMsg(txt, type) {
            try {
                await addDoc(collection(state.db, 'artifacts', appId, 'public', 'data', 'messages'), {
                    text: txt,
                    type: type,
                    sender: state.profile.name,
                    uid: state.user.uid,
                    isPrime: state.profile.isPrime,
                    ts: serverTimestamp()
                });
            } catch (e) { console.error(e); }
        },

        startListening() {
            const q = query(collection(state.db, 'artifacts', appId, 'public', 'data', 'messages'));
            onSnapshot(q, (snap) => {
                const container = document.getElementById('messages-container');
                container.innerHTML = '';
                const messages = snap.docs
                    .map(d => d.data())
                    .sort((a,b) => (a.ts?.toMillis() || 0) - (b.ts?.toMillis() || 0));
                
                messages.forEach(m => ui.renderMessage(m));
                container.scrollTop = container.scrollHeight;
            }, (err) => {
                console.error("Firestore Error:", err);
            });
        },

        togglePrime() {
            state.profile.isPrime = !state.profile.isPrime;
            localStorage.setItem('sm_prime', state.profile.isPrime);
            this.updateUIState();
        },

        updateUIState() {
            const btn = document.getElementById('prime-toggle');
            const circle = btn.querySelector('div');
            if (state.profile.isPrime) {
                btn.classList.replace('bg-slate-800', 'bg-blue-600');
                circle.style.left = '24px';
            } else {
                btn.classList.replace('bg-blue-600', 'bg-slate-800');
                circle.style.left = '4px';
            }
        },

        async logout() {
            await signOut(state.auth);
            location.reload();
        },

        clearAllData() {
            localStorage.clear();
            location.reload();
        }
    };

    window.ui = ui;
    window.appManager = appManager;
    window.router = ui;

    appManager.init();
</script>
</body>
</html>
