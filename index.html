<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmeshGram — Messenger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #0f172a; color: #f1f5f9; margin: 0; }
        .chat-bg { background-image: url('https://www.transparenttextures.com/patterns/cubes.png'); }
        .glass { background: rgba(15, 23, 42, 0.75); backdrop-filter: blur(12px); }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        
        .device-btn.active {
            background-color: #2563eb;
            border-color: #3b82f6;
            color: white;
            box-shadow: 0 0 15px rgba(37, 99, 235, 0.4);
        }
        .chat-item.active {
            background-color: rgba(37, 99, 235, 0.1);
            border-right: 4px solid #3b82f6;
        }
        .img-msg { max-width: 100%; border-radius: 0.75rem; margin-top: 0.5rem; border: 1px solid rgba(255,255,255,0.1); }
        .typing-dot { animation: typing 1.4s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 100% { opacity: 0.2; transform: translateY(0); } 50% { opacity: 1; transform: translateY(-2px); } }
    </style>
</head>
<body class="h-screen overflow-hidden">

<div id="app" class="flex h-full">
    <!-- Auth Screen -->
    <div id="auth-screen" class="fixed inset-0 z-[100] bg-slate-900 flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-slate-800 rounded-[2.5rem] p-8 shadow-2xl border border-slate-700 text-center">
            <div class="w-20 h-20 bg-blue-600 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-blue-900/40">
                <i data-lucide="zap" class="text-white w-10 h-10"></i>
            </div>
            <h1 class="text-3xl font-bold mb-2">SmeshGram</h1>
            <p class="text-slate-400 mb-6">Добро пожаловать в будущее</p>
            
            <div class="space-y-3 mb-6 text-left">
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase ml-2 mb-1 block">Никнейм</label>
                    <input id="login-input" type="text" placeholder="Ваше имя..." class="w-full bg-slate-700 border-none rounded-2xl py-4 px-6 outline-none focus:ring-2 focus:ring-blue-500 transition-all text-white">
                </div>
            </div>

            <button onclick="login()" class="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-2xl font-bold text-lg shadow-lg transition-transform active:scale-95">Войти</button>
        </div>
    </div>

    <!-- Main Interface -->
    <div id="main-interface" class="flex w-full h-full hidden">
        <!-- Sidebar -->
        <div class="w-full md:w-80 lg:w-96 flex flex-col border-r border-slate-800 bg-[#0f172a]">
            <div class="p-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div id="user-avatar-top" onclick="toggleProfile()" class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-white cursor-pointer hover:scale-110 transition-transform shadow-lg"></div>
                    <span class="font-extrabold text-xl tracking-tight">SmeshGram</span>
                </div>
                <button onclick="toggleProfile()" class="text-slate-500 hover:text-white p-2"><i data-lucide="settings"></i></button>
            </div>
            
            <div id="chat-list" class="flex-1 overflow-y-auto custom-scrollbar">
                <div onclick="selectChat('global')" id="chat-global" class="chat-item active p-4 flex items-center gap-4 cursor-pointer hover:bg-slate-800/50 transition-colors">
                    <div class="w-12 h-12 bg-blue-600 rounded-2xl flex items-center justify-center font-bold text-white shadow-lg shadow-blue-900/20">О</div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-bold text-blue-400">Общий чат</span>
                            <span class="text-[10px] text-slate-500 uppercase">Live</span>
                        </div>
                        <p class="text-sm text-slate-400 truncate">Все участники</p>
                    </div>
                </div>
                <div class="px-4 py-2 text-[10px] font-bold text-slate-500 uppercase tracking-widest mt-2 border-t border-slate-800 pt-4">Онлайн</div>
                <div id="users-online" class="space-y-1"></div>
            </div>
        </div>

        <!-- Chat Window -->
        <div class="flex-1 flex flex-col chat-bg relative bg-slate-900">
            <div class="h-16 glass border-b border-slate-800 flex items-center justify-between px-6 z-10">
                <div class="flex items-center gap-3">
                    <div id="current-chat-avatar" class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center font-bold text-white">О</div>
                    <div>
                        <h3 id="current-chat-name" class="font-bold text-sm text-white">Общий чат</h3>
                        <div id="typing-status" class="text-[10px] text-blue-400 font-bold hidden">
                            Печатает<span class="typing-dot">.</span><span class="typing-dot">.</span><span class="typing-dot">.</span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="chat-messages" class="flex-1 overflow-y-auto p-6 space-y-4 flex flex-col custom-scrollbar"></div>

            <div class="p-4 glass">
                <form onsubmit="event.preventDefault(); sendMsg();" class="max-w-4xl mx-auto flex items-center gap-3 bg-slate-800 rounded-2xl p-2 px-4 border border-slate-700">
                    <button type="button" onclick="promptImage()" class="text-slate-400 hover:text-blue-400"><i data-lucide="image"></i></button>
                    <input id="message-input" type="text" placeholder="Написать..." class="flex-1 bg-transparent border-none outline-none py-2 text-sm text-white">
                    <button type="submit" class="bg-blue-600 w-10 h-10 rounded-xl text-white shadow-lg flex items-center justify-center active:scale-90 transition-transform">
                        <i data-lucide="send" class="w-5 h-5"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profile-modal" class="fixed inset-0 bg-black/90 backdrop-blur-md z-[200] flex items-center justify-center p-4 hidden">
        <div class="bg-[#1e293b] w-full max-w-sm rounded-[2.5rem] overflow-hidden border border-slate-700 shadow-2xl">
            <div id="profile-bg" class="h-32 bg-blue-600"></div>
            <div class="px-6 pb-8 -mt-12">
                <div id="profile-avatar" class="w-24 h-24 rounded-3xl border-8 border-[#1e293b] flex items-center justify-center text-4xl font-bold shadow-2xl text-white"></div>
                <div class="mt-4">
                    <h2 id="profile-name" class="text-2xl font-bold text-white">User</h2>
                </div>
                <div class="mt-8 space-y-4">
                    <div class="flex gap-3 pt-4">
                        <button onclick="toggleProfile()" class="flex-1 bg-blue-600 py-3 rounded-2xl font-bold text-white">Ок</button>
                        <button onclick="logout()" class="flex-1 bg-slate-700 py-3 rounded-2xl font-bold text-red-400">Выйти</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, collection, query, onSnapshot, addDoc, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = JSON.parse(__firebase_config);
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'smeshgram-v4';

    let currentUser = null;
    let currentChatId = 'global';
    let state = {
        user: localStorage.getItem('smesh_user') || null,
        color: '#2563eb'
    };

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            if (state.user) {
                updateUI();
                registerUserPresence();
            }
            listenToMessages();
            listenToUsers();
            listenToTyping();
        } else {
            signInAnonymously(auth);
        }
    });

    async function registerUserPresence() {
        if (!currentUser || !state.user) return;
        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUser.uid), {
            username: state.user,
            color: state.color,
            lastSeen: serverTimestamp()
        }, { merge: true });
    }

    window.updateUI = () => {
        if (state.user) {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('main-interface').classList.remove('hidden');
            const initial = state.user[0].toUpperCase();
            document.getElementById('user-avatar-top').innerText = initial;
            document.getElementById('user-avatar-top').style.backgroundColor = state.color;
            document.getElementById('profile-avatar').innerText = initial;
            document.getElementById('profile-avatar').style.backgroundColor = state.color;
            document.getElementById('profile-name').innerText = state.user;
        }
        lucide.createIcons();
    };

    window.login = () => {
        const userVal = document.getElementById('login-input').value.trim();
        if (userVal) {
            state.user = userVal;
            localStorage.setItem('smesh_user', userVal);
            updateUI();
            registerUserPresence();
        }
    };

    window.promptImage = () => {
        const url = prompt("Вставь ссылку на картинку:");
        if (url) sendMsg(url, true);
    };

    window.selectChat = (chatId, name = 'Общий чат') => {
        currentChatId = chatId;
        document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));
        if (chatId === 'global') {
            document.getElementById('chat-global').classList.add('active');
            document.getElementById('current-chat-name').innerText = 'Общий чат';
            document.getElementById('current-chat-avatar').innerText = 'О';
        } else {
            const el = document.getElementById('user-' + chatId);
            if (el) el.classList.add('active');
            document.getElementById('current-chat-name').innerText = name;
            document.getElementById('current-chat-avatar').innerText = name[0].toUpperCase();
        }
        listenToMessages();
    };

    window.logout = () => { localStorage.clear(); location.reload(); };
    window.toggleProfile = () => document.getElementById('profile-modal').classList.toggle('hidden');

    window.sendMsg = async (val = null, isImage = false) => {
        const inp = document.getElementById('message-input');
        const text = val || inp.value.trim();
        if (!text || !currentUser) return;

        const coll = currentChatId === 'global' ? 'messages' : `dm_${[currentUser.uid, currentChatId].sort().join('_')}`;
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', coll), {
            text: text, isImage: isImage, sender: state.user, uid: currentUser.uid, timestamp: serverTimestamp()
        });
        if (!val) inp.value = '';
        setTyping(false);
    };

    let typingTimeout;
    document.getElementById('message-input').addEventListener('input', () => {
        setTyping(true);
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => setTyping(false), 2000);
    });

    async function setTyping(status) {
        if (!currentUser) return;
        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'typing', currentUser.uid), {
            isTyping: status, chat: currentChatId, username: state.user
        }, { merge: true });
    }

    function listenToTyping() {
        onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'typing'), (snap) => {
            const status = document.getElementById('typing-status');
            const typers = snap.docs.filter(d => d.id !== currentUser.uid && d.data().isTyping && d.data().chat === currentChatId);
            status.classList.toggle('hidden', typers.length === 0);
        });
    }

    function listenToUsers() {
        onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), (snap) => {
            const container = document.getElementById('users-online');
            container.innerHTML = '';
            snap.docs.forEach(d => {
                if (d.id === currentUser.uid) return;
                const data = d.data();
                const div = document.createElement('div');
                div.id = 'user-' + d.id;
                div.className = `chat-item p-3 mx-2 rounded-xl flex items-center gap-3 cursor-pointer hover:bg-slate-800 ${currentChatId === d.id ? 'active' : ''}`;
                div.onclick = () => window.selectChat(d.id, data.username);
                div.innerHTML = `<div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-white shadow-sm" style="background-color: ${data.color || '#334155'}">${data.username[0].toUpperCase()}</div><div class="flex-1 truncate font-bold text-sm text-slate-200">${data.username}</div>`;
                container.appendChild(div);
            });
        });
    }

    let msgUnsub = null;
    function listenToMessages() {
        if (msgUnsub) msgUnsub();
        const coll = currentChatId === 'global' ? 'messages' : `dm_${[currentUser.uid, currentChatId].sort().join('_')}`;
        msgUnsub = onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', coll)), (snap) => {
            const chat = document.getElementById('chat-messages');
            chat.innerHTML = '';
            const msgs = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => (a.timestamp?.seconds||0)-(b.timestamp?.seconds||0));
            msgs.forEach(m => {
                const isMine = m.uid === currentUser.uid;
                const div = document.createElement('div');
                div.className = `self-${isMine?'end':'start'} max-w-[75%] bg-${isMine?'blue-600':'slate-800'} p-3 rounded-2xl rounded-t${isMine?'l':'r'}-none text-white shadow-sm relative group`;
                div.innerHTML = `
                    ${!isMine && currentChatId==='global' ? `<div class="text-[10px] font-bold text-blue-400 mb-1">${m.sender}</div>`:''}
                    ${m.isImage ? `<img src="${m.text}" class="img-msg">` : `<span>${m.text}</span>`}
                    <div class="text-[9px] opacity-50 text-right mt-1">${m.timestamp ? new Date(m.timestamp.seconds*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : '...'}</div>
                    ${isMine ? `<button onclick="deleteMsg('${m.id}')" class="absolute -left-8 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 text-slate-500 hover:text-red-400 transition-all"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`:''}
                `;
                chat.appendChild(div);
            });
            chat.scrollTop = chat.scrollHeight;
            lucide.createIcons();
        });
    }

    window.deleteMsg = async (mid) => {
        if (confirm("Удалить?")) {
            const coll = currentChatId === 'global' ? 'messages' : `dm_${[currentUser.uid, currentChatId].sort().join('_')}`;
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', coll, mid));
        }
    };
</script>
</body>
</html>
