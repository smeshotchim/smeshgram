<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmeshGram Pro Fix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background: #020617; color: #f8fafc; margin: 0; height: 100vh; overflow: hidden; }
        .glass { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .btn-active:active { transform: scale(0.95); }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
        #boot-screen { position: fixed; inset: 0; z-index: 9999; background: #020617; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .loader { width: 40px; height: 40px; border: 4px solid #1e293b; border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- Экран загрузки -->
    <div id="boot-screen">
        <div class="loader"></div>
        <p class="mt-4 font-mono text-blue-500 animate-pulse">Инициализация системы...</p>
    </div>

    <!-- Контейнер авторизации -->
    <div id="auth-screen" class="hidden fixed inset-0 flex items-center justify-center p-4">
        <div class="glass w-full max-w-md p-8 rounded-[2rem] shadow-2xl text-center">
            <div class="w-20 h-20 bg-blue-600 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-blue-500/20 shadow-2xl">
                <i data-lucide="shield-check" class="text-white w-10 h-10"></i>
            </div>
            <h1 class="text-3xl font-extrabold mb-2">SmeshGram</h1>
            <p class="text-slate-400 mb-8">Введите имя для входа в сеть</p>
            
            <input id="username-input" type="text" placeholder="Ваш никнейм" 
                class="w-full bg-slate-900 border border-slate-800 rounded-2xl py-4 px-6 mb-4 outline-none focus:border-blue-500 transition-all text-white">
            
            <button id="login-btn-direct" onclick="handleLogin()"
                class="btn-active w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-2xl font-bold text-lg shadow-lg shadow-blue-900/40 transition-all">
                Войти в систему
            </button>
        </div>
    </div>

    <!-- Главный экран -->
    <div id="main-screen" class="hidden h-full flex flex-col">
        <header class="h-20 glass flex items-center justify-between px-6 border-b border-slate-800">
            <div class="flex items-center gap-4">
                <div id="my-avatar" class="w-12 h-12 rounded-xl bg-blue-600 flex items-center justify-center font-bold text-xl">?</div>
                <div>
                    <h2 id="my-name" class="font-bold">Загрузка...</h2>
                    <span class="text-[10px] text-emerald-500 font-bold uppercase tracking-widest">Online</span>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="toggleSettings(true)" class="p-3 hover:bg-slate-800 rounded-xl transition-all"><i data-lucide="settings" class="w-5 h-5 text-slate-400"></i></button>
                <button onclick="location.reload()" class="p-3 hover:bg-red-500/10 rounded-xl transition-all"><i data-lucide="log-out" class="w-5 h-5 text-red-500"></i></button>
            </div>
        </header>

        <div class="flex-1 flex overflow-hidden">
            <!-- Список пользователей -->
            <aside class="w-72 border-r border-slate-800/50 hidden md:flex flex-col p-4">
                <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-4 px-2">Пользователи</p>
                <div id="user-list" class="flex-1 overflow-y-auto space-y-2 custom-scroll"></div>
            </aside>

            <!-- Чат -->
            <main class="flex-1 flex flex-col bg-slate-950/50">
                <div id="chat-container" class="flex-1 overflow-y-auto p-6 space-y-4 custom-scroll"></div>
                
                <div class="p-6 glass">
                    <div class="max-w-4xl mx-auto flex items-center gap-4">
                        <input id="msg-input" type="text" placeholder="Написать сообщение..." 
                            class="flex-1 bg-slate-900 border border-slate-800 rounded-2xl py-4 px-6 outline-none focus:border-blue-500 transition-all text-white">
                        <button id="send-btn" onclick="handleSend()" class="btn-active w-14 h-14 bg-blue-600 rounded-2xl flex items-center justify-center text-white shadow-lg">
                            <i data-lucide="send" class="w-6 h-6"></i>
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Настройки -->
    <div id="settings-modal" class="hidden fixed inset-0 z-[100] bg-black/80 backdrop-blur-md flex items-center justify-center p-4">
        <div class="glass w-full max-w-sm p-8 rounded-[2.5rem]">
            <h3 class="text-2xl font-bold mb-6">Цвет профиля</h3>
            <div class="grid grid-cols-4 gap-4 mb-8">
                <div onclick="updateColor('#3b82f6')" class="w-full aspect-square rounded-xl bg-blue-500 cursor-pointer"></div>
                <div onclick="updateColor('#ef4444')" class="w-full aspect-square rounded-xl bg-red-500 cursor-pointer"></div>
                <div onclick="updateColor('#10b981')" class="w-full aspect-square rounded-xl bg-emerald-500 cursor-pointer"></div>
                <div onclick="updateColor('#f59e0b')" class="w-full aspect-square rounded-xl bg-amber-500 cursor-pointer"></div>
            </div>
            <button onclick="toggleSettings(false)" class="w-full bg-white text-black py-4 rounded-2xl font-bold">Закрыть</button>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, collection, query, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Инициализация
    const fbConfig = JSON.parse(__firebase_config);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'smesh-fix-v1';
    const app = initializeApp(fbConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Состояние
    const state = {
        user: null,
        name: localStorage.getItem('smesh_name') || '',
        color: localStorage.getItem('smesh_color') || '#3b82f6'
    };

    // Глобальные функции (для onclick)
    window.handleLogin = async () => {
        const input = document.getElementById('username-input');
        const name = input.value.trim();
        if (name.length < 2) return;

        state.name = name;
        localStorage.setItem('smesh_name', name);
        
        const btn = document.getElementById('login-btn-direct');
        btn.innerText = "Вход...";
        btn.disabled = true;

        try {
            await signInAnonymously(auth);
            await syncPresence();
            refreshUI();
        } catch (e) {
            alert("Ошибка входа: " + e.message);
            btn.disabled = false;
            btn.innerText = "Войти в систему";
        }
    };

    window.handleSend = async () => {
        const input = document.getElementById('msg-input');
        const text = input.value.trim();
        if (!text || !state.user) return;

        input.value = '';
        try {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), {
                text,
                sender: state.name,
                color: state.color,
                uid: state.user.uid,
                ts: serverTimestamp()
            });
        } catch (e) { console.error(e); }
    };

    window.toggleSettings = (show) => {
        document.getElementById('settings-modal').classList.toggle('hidden', !show);
    };

    window.updateColor = async (c) => {
        state.color = c;
        localStorage.setItem('smesh_color', c);
        await syncPresence();
        refreshUI();
        toggleSettings(false);
    };

    async function syncPresence() {
        if (!state.user || !state.name) return;
        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'presence', state.user.uid), {
            name: state.name,
            color: state.color,
            last: serverTimestamp()
        });
    }

    function refreshUI() {
        const isLogged = !!(state.user && state.name);
        document.getElementById('auth-screen').classList.toggle('hidden', isLogged);
        document.getElementById('main-screen').classList.toggle('hidden', !isLogged);
        
        if (isLogged) {
            document.getElementById('my-name').innerText = state.name;
            document.getElementById('my-avatar').innerText = state.name[0].toUpperCase();
            document.getElementById('my-avatar').style.backgroundColor = state.color;
        }
        lucide.createIcons();
    }

    // Слушатели данных
    function initSubscriptions() {
        // Сообщения
        onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), (snap) => {
            const container = document.getElementById('chat-container');
            container.innerHTML = '';
            const msgs = snap.docs.map(d => d.data()).sort((a,b) => (a.ts?.toMillis() || 0) - (b.ts?.toMillis() || 0));
            
            msgs.forEach(m => {
                const isMe = m.uid === state.user?.uid;
                const div = document.createElement('div');
                div.className = `flex ${isMe ? 'justify-end' : 'justify-start'}`;
                div.innerHTML = `
                    <div class="max-w-[80%] p-4 rounded-2xl ${isMe ? 'bg-blue-600' : 'bg-slate-800'}" style="${isMe ? '' : 'border-left: 4px solid ' + m.color}">
                        <p class="text-[10px] font-bold opacity-50 mb-1">${m.sender}</p>
                        <p class="text-sm">${m.text}</p>
                    </div>
                `;
                container.appendChild(div);
            });
            container.scrollTop = container.scrollHeight;
        });

        // Пользователи
        onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'presence'), (snap) => {
            const list = document.getElementById('user-list');
            list.innerHTML = '';
            snap.docs.forEach(d => {
                const u = d.data();
                const item = document.createElement('div');
                item.className = "flex items-center gap-3 p-2 rounded-lg bg-slate-900/50";
                item.innerHTML = `
                    <div class="w-8 h-8 rounded-md flex items-center justify-center text-xs font-bold" style="background:${u.color}">${u.name[0].toUpperCase()}</div>
                    <span class="text-xs font-medium">${u.name}</span>
                `;
                list.appendChild(item);
            });
        });
    }

    // Запуск
    onAuthStateChanged(auth, (user) => {
        state.user = user;
        document.getElementById('boot-screen').style.opacity = '0';
        setTimeout(() => document.getElementById('boot-screen').classList.add('hidden'), 500);
        
        if (user && state.name) {
            initSubscriptions();
            syncPresence();
        }
        refreshUI();
    });

    // Обработка Enter
    document.getElementById('msg-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleSend();
    });

    lucide.createIcons();
</script>
</body>
</html>
