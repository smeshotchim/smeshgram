<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmeshGram Pro ‚Äî Ultimate Experience</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        
        :root {
            --accent: #3b82f6;
            --accent-glow: rgba(59, 130, 246, 0.5);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617;
            color: #e2e8f0;
            overflow: hidden;
            height: 100vh;
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .smesh-avatar-main {
            background-image: url('https://r.jina.ai/i/9e67c858be8540c1a9657c91795796f6');
            background-size: cover;
            background-position: center;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π */
        @keyframes messageIn {
            from { opacity: 0; transform: translateY(20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .animate-message { animation: messageIn 0.3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }

        /* –ö–∞—Å—Ç–æ–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª–±–∞—Ä */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(59, 130, 246, 0.2); border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        .prime-border {
            position: relative;
            z-index: 1;
        }
        .prime-border::before {
            content: '';
            position: absolute;
            inset: -2px;
            background: linear-gradient(45deg, #3b82f6, #8b5cf6, #3b82f6);
            background-size: 200% 200%;
            border-radius: inherit;
            z-index: -1;
            animation: gradient-flow 3s linear infinite;
            opacity: 0.6;
        }
        @keyframes gradient-flow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
    <div id="toast-container" class="fixed top-6 right-6 z-[3000] flex flex-col gap-3 pointer-events-none"></div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
    <div id="app-root" class="flex flex-1 overflow-hidden relative">
        
        <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å: –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ -->
        <aside class="w-[320px] glass-panel border-r border-slate-800 flex flex-col z-20 hidden md:flex">
            <div class="p-6 shrink-0">
                <div class="flex items-center justify-between mb-6">
                    <h1 class="text-2xl font-black italic tracking-tighter text-white">SMESH<span class="text-blue-500">GRAM</span></h1>
                    <div class="w-10 h-10 smesh-avatar-main rounded-xl border border-blue-500/30"></div>
                </div>
                <div class="relative group">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500 group-focus-within:text-blue-500 transition-colors"></i>
                    <input type="text" placeholder="–ü–æ–∏—Å–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤..." class="w-full bg-slate-900/50 border border-slate-800 rounded-xl py-2.5 pl-10 pr-4 text-sm outline-none focus:border-blue-500/50 transition-all">
                </div>
            </div>

            <div class="flex-1 overflow-y-auto custom-scroll px-3 space-y-1">
                <!-- –ê–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç -->
                <div class="p-4 bg-blue-600/10 border border-blue-500/20 rounded-2xl cursor-pointer transition-all">
                    <div class="flex gap-3">
                        <div class="w-12 h-12 smesh-avatar-main rounded-2xl border border-blue-500/50"></div>
                        <div class="flex-1 overflow-hidden">
                            <div class="flex justify-between items-start">
                                <span class="font-bold text-sm text-white flex items-center gap-1 italic">–û–±—â–∏–π –ß–∞—Ç <i data-lucide="check-circle-2" class="w-3 h-3 text-blue-400"></i></span>
                                <span class="text-[10px] text-slate-500 font-medium">14:20</span>
                            </div>
                            <p class="text-xs text-slate-400 truncate mt-1">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ SmeshGram Pro!</p>
                        </div>
                    </div>
                </div>

                <!-- –§–µ–π–∫–æ–≤—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è –≤–∏–¥–∞ -->
                <div class="p-4 hover:bg-white/5 rounded-2xl cursor-not-allowed transition-all opacity-50 grayscale">
                    <div class="flex gap-3">
                        <div class="w-12 h-12 bg-slate-800 rounded-2xl flex items-center justify-center font-bold text-slate-500">P</div>
                        <div class="flex-1">
                            <span class="font-bold text-sm">Pavel Durov</span>
                            <p class="text-xs text-slate-500 truncate mt-1">–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ù–∏–∂–Ω—è—è —á–∞—Å—Ç—å –ø—Ä–æ—Ñ–∏–ª—è -->
            <div class="p-4 border-t border-slate-800 bg-slate-950/50">
                <div class="flex items-center gap-3 p-2">
                    <div id="user-status-dot" class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                    <span id="my-name-display" class="font-bold text-sm truncate uppercase tracking-wider">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                </div>
            </div>
        </aside>

        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å: –ß–∞—Ç -->
        <main class="flex-1 flex flex-col relative z-10 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-blue-900/10 via-slate-950 to-slate-950">
            <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å —á–∞—Ç–∞ -->
            <header class="h-20 glass-panel border-b border-slate-800 flex items-center justify-between px-6 shrink-0">
                <div class="flex items-center gap-4">
                    <div class="md:hidden">
                         <div class="w-10 h-10 smesh-avatar-main rounded-xl border border-blue-500/30"></div>
                    </div>
                    <div>
                        <h2 class="font-black text-white italic uppercase tracking-tight">Global Room</h2>
                        <p class="text-[10px] text-emerald-400 font-bold flex items-center gap-1 uppercase tracking-widest"><span class="w-1 h-1 bg-emerald-400 rounded-full"></span> 248 Online</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="ui.toggleSettings()" class="p-3 bg-slate-900 border border-slate-800 rounded-2xl text-slate-400 hover:text-white hover:border-slate-700 transition-all"><i data-lucide="sliders-horizontal" class="w-5 h-5"></i></button>
                </div>
            </header>

            <!-- –û–±–ª–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π -->
            <div id="chat-messages" class="flex-1 overflow-y-auto p-6 space-y-6 custom-scroll">
                <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç —Ç—É—Ç -->
            </div>

            <!-- –ü–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ -->
            <div class="p-6 bg-slate-950/80 backdrop-blur-xl border-t border-slate-800">
                <div class="max-w-5xl mx-auto flex items-end gap-3">
                    <div class="flex-1 relative">
                        <textarea id="message-input" rows="1" placeholder="–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                            class="w-full bg-slate-900 border border-slate-800 rounded-2xl py-4 pl-6 pr-14 outline-none focus:border-blue-500/50 text-slate-200 transition-all resize-none custom-scroll"></textarea>
                        <button id="sticker-btn" class="absolute right-4 bottom-4 text-slate-500 hover:text-blue-400 transition-colors">
                            <i data-lucide="smile" class="w-6 h-6"></i>
                        </button>
                    </div>
                    <button id="send-btn" class="w-14 h-14 bg-blue-600 hover:bg-blue-500 text-white rounded-2xl flex items-center justify-center shadow-lg shadow-blue-600/20 transition-all active:scale-90 transform">
                        <i data-lucide="send" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>
        </main>

        <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (–°–∫—Ä—ã—Ç–∞ –ø–æ –¥–µ—Ñ–æ–ª—Ç—É) -->
        <aside id="settings-panel" class="w-[300px] glass-panel border-l border-slate-800 absolute right-0 top-0 bottom-0 z-30 translate-x-full transition-transform duration-300">
            <div class="p-8">
                <div class="flex justify-between items-center mb-8">
                    <h3 class="text-xl font-black italic uppercase">Settings</h3>
                    <button onclick="ui.toggleSettings()" class="text-slate-500 hover:text-white"><i data-lucide="x"></i></button>
                </div>

                <div class="space-y-6">
                    <div class="p-4 bg-slate-900/50 rounded-2xl border border-slate-800">
                        <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest block mb-4">–°—Ç–∞—Ç—É—Å –∞–∫–∫–∞—É–Ω—Ç–∞</label>
                        <div class="flex items-center justify-between">
                            <span class="font-bold italic text-amber-500 flex items-center gap-2">PRIME <i data-lucide="crown" class="w-4 h-4"></i></span>
                            <div class="w-12 h-6 bg-blue-600 rounded-full relative cursor-pointer" onclick="app.togglePrime()">
                                <div id="prime-slider" class="w-4 h-4 bg-white rounded-full absolute top-1 right-1 transition-all"></div>
                            </div>
                        </div>
                    </div>

                    <div class="p-4 bg-slate-900/50 rounded-2xl border border-slate-800">
                        <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest block mb-4">–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</label>
                        <button onclick="app.logout()" class="w-full py-3 bg-red-500/10 text-red-500 rounded-xl text-xs font-bold uppercase tracking-widest hover:bg-red-500 hover:text-white transition-all">–í—ã–π—Ç–∏ –∏–∑ —Å–µ—Ç–∏</button>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ —Å—Ç–∏–∫–µ—Ä–æ–≤ -->
    <div id="sticker-modal" class="hidden absolute bottom-28 left-1/2 -translate-x-1/2 w-[350px] p-6 glass-panel rounded-[2.5rem] shadow-2xl z-40 border border-blue-500/20">
        <div class="grid grid-cols-4 gap-4" id="sticker-grid">
            <!-- Stickers -->
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // –ë–∞–∑–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    const firebaseConfig = JSON.parse(__firebase_config);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'smeshgram-pro-main';
    
    // –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    const state = {
        user: null,
        db: null,
        auth: null,
        profile: {
            name: localStorage.getItem('sm_name') || 'Guest',
            isPrime: localStorage.getItem('sm_prime') === 'true'
        }
    };

    // UI –ú–µ–Ω–µ–¥–∂–µ—Ä
    const ui = {
        init() {
            lucide.createIcons();
            document.getElementById('my-name-display').innerText = state.profile.name;
            this.renderStickers();
            this.setupAutoResize();
        },
        toggleSettings() {
            const panel = document.getElementById('settings-panel');
            panel.classList.toggle('translate-x-full');
        },
        showToast(msg, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `p-4 glass-panel border-l-4 rounded-xl text-xs font-bold shadow-2xl animate-message pointer-events-auto ${type === 'error' ? 'border-red-500' : 'border-blue-500'}`;
            toast.innerText = msg;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        },
        renderStickers() {
            const stickers = ['üóø','üî•','ü¶æ','üëë','üöÄ','üíé','üòé','‚ö°','ü§ô','üëæ','üí∏','üíä'];
            const grid = document.getElementById('sticker-grid');
            stickers.forEach(s => {
                const btn = document.createElement('button');
                btn.className = "text-3xl hover:scale-125 transition-transform active:scale-90 p-2";
                btn.innerText = s;
                btn.onclick = () => app.sendMsg(s, 'sticker');
                grid.appendChild(btn);
            });
        },
        setupAutoResize() {
            const tx = document.getElementById('message-input');
            tx.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
                if (this.scrollHeight > 150) this.style.overflowY = 'auto';
                else this.style.overflowY = 'hidden';
            });
        },
        appendMessage(data) {
            const container = document.getElementById('chat-messages');
            const isMe = data.uid === state.user?.uid;
            const isSticker = data.type === 'sticker';

            const msgDiv = document.createElement('div');
            msgDiv.className = `flex flex-col ${isMe ? 'items-end' : 'items-start'} animate-message group`;
            
            msgDiv.innerHTML = `
                <div class="flex items-center gap-2 mb-1 px-2">
                    ${data.isPrime ? '<span class="text-amber-500 text-[10px] animate-pulse">üëë</span>' : ''}
                    <span class="text-[10px] font-black uppercase text-slate-500 tracking-tighter">${data.sender}</span>
                </div>
                <div class="${isSticker ? 'text-6xl p-2 select-none' : (isMe ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-slate-900 text-slate-200 border border-slate-800 rounded-tl-none')} px-5 py-3 rounded-2xl text-sm font-medium shadow-xl max-w-[80%] break-words">
                    ${data.text}
                </div>
            `;
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }
    };

    // –ü—Ä–∏–∫–ª–∞–¥–Ω–∞—è –ª–æ–≥–∏–∫–∞
    const app = {
        async init() {
            const fbApp = initializeApp(firebaseConfig);
            state.auth = getAuth(fbApp);
            state.db = getFirestore(fbApp);

            onAuthStateChanged(state.auth, (user) => {
                if (user) {
                    state.user = user;
                    ui.showToast(`–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∫–∞–∫ ${state.profile.name}`);
                    this.listenMessages();
                } else {
                    window.location.href = 'index.html'; // –†–µ–¥–∏—Ä–µ–∫—Ç –µ—Å–ª–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
                }
            });

            this.bindEvents();
            ui.init();
        },

        bindEvents() {
            document.getElementById('send-btn').onclick = () => this.sendMsg();
            document.getElementById('message-input').onkeydown = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.sendMsg();
                }
            };
            document.getElementById('sticker-btn').onclick = () => {
                document.getElementById('sticker-modal').classList.toggle('hidden');
            };
        },

        async sendMsg(content = null, type = 'text') {
            const input = document.getElementById('message-input');
            const text = content || input.value.trim();
            
            if (!text || !state.user) return;
            if (!content) input.value = '';
            if (type === 'sticker') document.getElementById('sticker-modal').classList.add('hidden');
            
            try {
                await addDoc(collection(state.db, 'artifacts', appId, 'public', 'data', 'messages'), {
                    text,
                    type,
                    sender: state.profile.name,
                    uid: state.user.uid,
                    isPrime: state.profile.isPrime,
                    ts: serverTimestamp()
                });
            } catch (e) {
                ui.showToast("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏", "error");
            }
        },

        listenMessages() {
            const q = query(collection(state.db, 'artifacts', appId, 'public', 'data', 'messages'));
            onSnapshot(q, (snap) => {
                const container = document.getElementById('chat-messages');
                container.innerHTML = '';
                const sorted = snap.docs
                    .map(d => d.data())
                    .sort((a,b) => (a.ts?.toMillis() || 0) - (b.ts?.toMillis() || 0));
                
                sorted.forEach(m => ui.appendMessage(m));
            });
        },

        togglePrime() {
            state.profile.isPrime = !state.profile.isPrime;
            localStorage.setItem('sm_prime', state.profile.isPrime);
            const slider = document.getElementById('prime-slider');
            slider.classList.toggle('right-1');
            slider.classList.toggle('left-1');
            ui.showToast(state.profile.isPrime ? "Prime —Å—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!" : "Prime —Å—Ç–∞—Ç—É—Å –æ—Ç–∫–ª—é—á–µ–Ω");
        },

        async logout() {
            await signOut(state.auth);
            localStorage.removeItem('sm_name');
            window.location.reload();
        }
    };

    window.ui = ui;
    window.app = app;
    app.init();
</script>
</body>
</html>
